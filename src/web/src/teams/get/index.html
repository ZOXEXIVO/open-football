{% extends "layout.html" %}

{% block submenu %}
<div class="fm-tabbar">
    <a class="fm-tab active" href="/{{ lang }}/teams/{{ team_slug }}">{{ i18n.t("squad") }}</a>
    <a class="fm-tab" href="/{{ lang }}/teams/{{ team_slug }}/staff">{{ i18n.t("staff") }}</a>
    <a class="fm-tab" href="/{{ lang }}/teams/{{ team_slug }}/tactics">{{ i18n.t("tactics") }}</a>
    <a class="fm-tab" href="/{{ lang }}/teams/{{ team_slug }}/schedule">{{ i18n.t("schedule") }}</a>
    <a class="fm-tab" href="/{{ lang }}/teams/{{ team_slug }}/stats">{{ i18n.t("stats") }}</a>
    <a class="fm-tab" href="/{{ lang }}/teams/{{ team_slug }}/transfers">{{ i18n.t("transfers") }}</a>
</div>
{% endblock %}

{% block content %}
<div class="fm-page">
    <section class="fm-panel">
        <div class="fm-panel-head">
            <h3>{{ i18n.t("squad") }}</h3>
        </div>
        <table class="fm-squad">
            <thead>
                <tr>
                    <th class="sq-inf"></th>
                    <th class="sq-name">{{ i18n.t("name") }}</th>
                    <th>{{ i18n.t("position") }}</th>
                    <th class="sq-nat">{{ i18n.t("nat") }}</th>
                    <th class="sq-age">{{ i18n.t("age") }}</th>
                    <th class="sq-ability">{{ i18n.t("ability") }}</th>
                    <th class="sq-potential">{{ i18n.t("potential") }}</th>
                    <th class="sq-cond">{{ i18n.t("condition") }}</th>
                    <th class="sq-morale">{{ i18n.t("morale") }}</th>
                    <th class="sq-games">{{ i18n.t("apps") }}</th>
                    <th class="sq-value">{{ i18n.t("value") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr{% if player.is_loan %} class="sq-loan-in"{% endif %}{% if player.is_loaned_out %} class="sq-loan-out"{% endif %}>
                    <td class="sq-inf">
                        <div class="fm-badge-deck">
                            {% if player.injured %}
                            <span class="fm-badge fm-badge-inj">{{ i18n.t("inj") }}</span>
                            {% endif %}
                            {% if player.unhappy %}
                            <span class="fm-badge fm-badge-unh">{{ i18n.t("unh") }}</span>
                            {% endif %}
                            {% if player.transfer_listed %}
                            <span class="fm-badge fm-badge-lst">{{ i18n.t("lst") }}</span>
                            {% endif %}
                            {% if player.is_youth %}
                            <span class="fm-badge fm-badge-yth">Yth</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="sq-name">
                        <a href="/{{ lang }}/players/{{ player.id }}">
                            {{ player.last_name }}&nbsp;{{ player.first_name }}
                        </a>
                    </td>
                    <td class="sq-pos">{{ player.position }}</td>
                    <td class="sq-nat">
                        <a href="/{{ lang }}/countries/{{ player.country_slug }}">
                            <span class="flag flag-{{ player.country_code }}" title="{{ player.country_name }}"></span>
                        </a>
                    </td>
                    <td class="sq-age">{{ player.age }}</td>
                    <td>
                        <div class="fm-stars">
                            {% for _ in 0..player.current_ability %}<span class="star on"></span>{% endfor %}{% for _ in 0..(5 - player.current_ability) %}<span class="star"></span>{% endfor %}
                        </div>
                    </td>
                    <td>
                        <div class="fm-stars">
                            {% for _ in 0..player.potential_ability %}<span class="star on"></span>{% endfor %}{% for _ in 0..(5 - player.potential_ability) %}<span class="star"></span>{% endfor %}
                        </div>
                    </td>
                    <td class="sq-cond">
                        <div class="fm-cond">
                            <div class="fm-cond-bar"><div class="fm-cond-fill" style="width:{{ player.conditions }}%"></div></div>
                            <span class="fm-cond-val">{{ player.conditions }}%</span>
                        </div>
                    </td>
                    <td class="sq-morale">{{ player.behaviour }}</td>
                    <td class="sq-games">{% if player.played > 0 || player.played_subs > 0 %}{{ player.played }}{% if player.played_subs > 0 %} ({{ player.played_subs }}){% endif %}{% else %}-{% endif %}</td>
                    <td class="sq-value">{{ player.value }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    function initDecks() {
        document.querySelectorAll('.fm-badge-deck').forEach(function(deck) {
            if (deck.dataset.init) return;
            deck.dataset.init = '1';

            var badges = Array.from(deck.querySelectorAll('.fm-badge'));
            if (badges.length < 2) return;

            badges.sort(function(a, b) {
                var aInj = a.classList.contains('fm-badge-inj');
                var bInj = b.classList.contains('fm-badge-inj');
                if (aInj && !bInj) return -1;
                if (!aInj && bInj) return 1;
                return badgeClass(a).localeCompare(badgeClass(b));
            });

            badges.forEach(function(b) { deck.appendChild(b); });
            deck.setAttribute('data-count', badges.length);
            setCollapsed(badges);

            deck.addEventListener('click', function(e) {
                e.stopPropagation();
                if (deck.classList.contains('open')) {
                    deck.classList.remove('open');
                    setCollapsed(badges);
                } else {
                    closeAll();
                    deck.classList.add('open');
                    setExpanded(badges);
                }
            });
        });
    }

    function badgeClass(el) {
        for (var i = 0; i < el.classList.length; i++) {
            if (el.classList[i] !== 'fm-badge' && el.classList[i].indexOf('fm-badge-') === 0)
                return el.classList[i];
        }
        return '';
    }

    function setCollapsed(badges) {
        var len = badges.length;
        badges.forEach(function(b, i) {
            b.style.transform = i === 0 ? '' : 'translateY(' + (i * 5) + 'px)';
            b.style.zIndex = String(len - i);
        });
    }

    function setExpanded(badges) {
        var offset = 0;
        badges.forEach(function(b, i) {
            if (i === 0) {
                b.style.transform = '';
                b.style.zIndex = '';
                offset = b.offsetWidth + 4;
            } else {
                b.style.transform = 'translateX(' + offset + 'px)';
                b.style.zIndex = '1';
                offset += b.offsetWidth + 4;
            }
        });
    }

    function closeAll() {
        document.querySelectorAll('.fm-badge-deck.open').forEach(function(deck) {
            deck.classList.remove('open');
            setCollapsed(Array.from(deck.querySelectorAll('.fm-badge')));
        });
    }

    document.addEventListener('click', closeAll);
    initDecks();
})();
</script>
{% endblock %}
